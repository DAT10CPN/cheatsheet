\section*{Rule S: Atomic free agglomeration with k-scaling (CPN)}\label{sec:rule_s_cpn}
A free agglomeration is a pre agglomeration, which does not require that the pre set of the preset of $p_0$ has a single consumer.
In turn, it is only correct for reachability with deadlocks.
The atomic free agglomeration is similar to the free agglomeration, but is able to agglomeration one consumer at a time.
See Figure~\ref{fig:rule_s_cpn} for its definition.
Rule~S also handles cases where the producer $h$ produces $k$ times more tokens than what the consumer $f_0$ consumes.
In this case, a transition $\langle h f_0^i\rangle$ is created for each $i\in [1, k]$.
Thus all relevant markings remain reachable.

\begin{theorem}
    Rule~S in Figure~\ref{fig:rule_s_cpn} is correct for reachability without deadlock.
\end{theorem}

\begin{figure}
    \centering
    \begin{tikzpicture}
        \tikzstyle{every node}=[font=\small]
        %%% Before
        \begin{scope}[scale=0.5]
            \node[place,label=left:$p_0$] (p0) at (0,0) {};
            \node (h1pre1) at (-3,6) {};
            \node (h1pre2) at (-1,6) {};
            \node (hnpre1) at (1,6) {};
            \node (hnpre2) at (3,6) {};
            \node (f1pre) at (-4,-1.8) {};
            \node (f1post1) at (-3,-6) {};
            \node (f1post2) at (-1,-6) {};
            \node (fmpre) at (3,-1) {};
            \node (fmpost1) at (1,-6) {};
            \node (fmpost2) at (3,-6) {};
            \node (fm) at (2,-3) {};

            \node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$h_1$] (h1) at (-2,3) {};
            \node (hdots) at (0,3) {$\dots$};
            \node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$h_n$] (hn) at (2,3) {};
            \node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$f_0$] (f1) at (-2,-3) {};
            %\node (fdots) at (-2,-5) {$\dots$};
            %\node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$f_m$] (fm) at (2,-3) {};

            \draw[-latex,thick] (h1pre1) edge (h1);
            \draw[-latex,thick] (h1pre2) edge (h1);
            \draw[-latex,thick] (hnpre1) edge (hn);
            \draw[-latex,thick] (hnpre2) edge (hn);
            \draw[-latex,thick] (h1) edge node[left] {$k_1 \cdot w'x$} (p0);
            \draw[-latex,thick] (hn) edge node[right] {$k_n \cdot w'x$} (p0);
            \draw[-latex,thick] (p0) edge node[left] {$w'x$} (f1);
            \draw[-latex,thick] (p0) edge node[right] {} (fm);
            \draw[-latex,thick] (f1pre) edge (f1);
            \draw[-latex,thick] (f1) edge node[left] {$v_1$} (f1post1);
            \draw[-latex,thick] (f1) edge node[right] {$v_2$} (f1post2);
            %\draw[-latex,thick] (fmpre) edge (fm);
            %\draw[-latex,thick] (fm) edge (fmpost1);
            %\draw[-latex,thick] (fm) edge (fmpost2);
        \end{scope}

        \node (arrow) at (2,0) {\Large $\Rightarrow$};

        %%% After
        \begin{scope}[shift={(4,0)},scale=0.6]
        \node (p1) at (-1,2.5) {};
        \node (p2) at (-1.5,0.9) {};
        \node (p9) at (1,2.5) {};
        \node (p3) at (1,2.5) {};
        \node (p4) at (2,2.5) {};
        \node (p10) at (3,2.5) {};
        \node (p5) at (-0.5,-2.5) {};
        \node (p6) at (0.5,-2.5) {};
        \node (p7) at (1.5,-2.5) {};
        \node (p8) at (2.5,-2.5) {};

        \node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$\langle h_j f_0^{i}\rangle$] (hjfi) at (0,0) {};
        \node[text width=2.5cm] (explain) at (3,-3.5) {for all $i$ and $j$ s.t. $1\leq j\leq n$\\$1 \leq i\leq k_j$};

        \draw[-latex,thick] (p1) edge (hjfi);
        \draw[-latex,thick] (p2) edge (hjfi);
        \draw[-latex,thick] (p9) edge (hjfi);
        % \draw[-latex,thick] (p3) edge (hnfm);
        % \draw[-latex,thick] (p4) edge (hnfm);
        % \draw[-latex,thick] (p10) edge (hnfm);
        \draw[-latex,thick] (hjfi) edge node[left] {$i \cdot v_1$} (p5);
        \draw[-latex,thick] (hjfi) edge node[right] {$i \cdot v_2$} (p6);
            % \draw[-latex,thick] (hnfm) edge node[left] {} (p7);
        \end{scope}
        \begin{scope}[shift={(7,0)}, scale=0.5]
        \node[place,label=right:$p_0$] (p0) at (0,0) {};
        \node (h1pre1) at (-3,6) {};
        \node (h1pre2) at (-1,6) {};
        \node (hnpre1) at (1,6) {};
        \node (hnpre2) at (3,6) {};
        %\node (f1pre) at (-3,-1) {};
        %\node (f1post1) at (-3,-6) {};
        %\node (f1post2) at (-1,-6) {};
        \node (fmpre) at (3,-1) {};
        \node (fmpost1) at (1,-6) {};
        \node (fmpost2) at (3,-6) {};
        \node (fm) at (2,-3) {};

        \node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$h_1$] (h1) at (-2,3) {};
        \node (hdots) at (0,3) {$\dots$};
        \node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$h_n$] (hn) at (2,3) {};
        %\node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$f_0$] (f1) at (-2,-3) {};
        %\node (fdots) at (-2,-5) {$\dots$};
        %\node[transition,minimum height=6mm,minimum width=2mm,fill=black,label=left:$f_m$] (fm) at (2,-3) {};

        \draw[-latex,thick] (h1pre1) edge (h1);
        \draw[-latex,thick] (h1pre2) edge (h1);
        \draw[-latex,thick] (hnpre1) edge (hn);
        \draw[-latex,thick] (hnpre2) edge (hn);
        \draw[-latex,thick] (h1) edge node[left] {$w'x$} (p0);
        \draw[-latex,thick] (hn) edge node[right] {$w'x$} (p0);
        %\draw[-latex,thick] (p0) edge node[left] {$W$} (f1);
        \draw[-latex,thick] (p0) edge node[right] {} (fm);
        \draw[-latex,thick] (hjfi) edge node[below] {$((k_j-i)  \cdot  w)'x$} (p0);
            %\draw[-latex,thick] (f1pre) edge (f1);
            %\draw[-latex,thick] (f1) edge node[left] {} (f1post1);
            %\draw[-latex,thick] (f1) edge node[right] {} (f1post2);
            %\draw[-latex,thick] (fmpre) edge (fm);
            %\draw[-latex,thick] (fm) edge (fmpost1);
            %\draw[-latex,thick] (fm) edge (fmpost2);
        \end{scope}
    \end{tikzpicture}
    \vspace{5mm}
    \begin{adjustbox}{center}
        \begin{tabular}{|p{70mm}|p{70mm}|} \hline
        Precondition & Update \\ \hline
        Fix place $p_0$ and transition $f_0$ s.t.:
        \begin{itemize}[leftmargin=10mm]
            \item[S1)] $(\{p_0\} \cap places(\varphi) = \emptyset$
            \item[S2)] $({}^\bullet p_0 \cup p_0^\bullet \cup ({}^\bullet {}^\bullet p_0)^\bullet) \cap transitions(\varphi) = \emptyset$
            \item[S3)] $M_0(p_0)=\emptyset$
            \item[S4)] $^\bullet p_0 \cap p_0^\bullet = \emptyset$
            \item[S5)] $f_0 \in p_0^\bullet$
            \item[S6)] $|\textbf{Supp}(\boxminus(p_0, f_0))| = 1$
        \end{itemize}
        \hspace{2mm}
        and for all $h\in{}^\bullet p$:
        \begin{itemize}[leftmargin=10mm]
            \item[S7)] $h^\bullet=\{p_0\}$
            \item[S8)] ${}^\bullet h \cap places(\varphi) = \emptyset$
            \item[S9)] $p_0^\circ = {}^\circ h = ({}^\bullet h)^\circ = \emptyset$
            %\item[S10)] $|\boxplus(h, p_0)| = |\boxminus(p_0, f_0)|$
            \item[S10)] $|\boxplus(h, p_0)| = k * |\boxminus(p_0, f_0)|$
            \item[S11)] $k > 1 \implies{}^\bullet f_0 = \{p_0\}$
            \item[S12)] $k > 1 \implies (f_0^\bullet)^\circ = \emptyset$
        \end{itemize}
        And for each variable $v \in ((\boxplus(h, p_0) \cup \boxminus(p_0, f_0)) \cap (\textbf{Vars}(G(h)) \cup \textbf{Vars}(G(f_0)))$\newline
        there exists a $p$ \in P\backslash $\{p_0\}$ such that:
        \begin{itemize}[leftmargin=13mm]
            \item[S13)] $v \in (\textbf{Vars}(\boxplus(h, p)) \cup \textbf{Vars}(\boxminus(p, f_0)))$
        \end{itemize}

        &
        For all $h\in{}^\bullet p_0$, create a transition $\langle hf\rangle$ s.t. for all $p\in P\setminus\{p_0\}$, for all $i \in [1,k]$ for the $k$ such that $|\boxplus(h, p_0)| = k*|\boxminus(p_0, f_0)|$:
        \begin{itemize}[leftmargin=10mm]
            \item[US1)] For all $v \in \textbf{Vars}(f_0)$, $rename(f_0,v,v')$ with some $v' \in \textbf{Var}_{\mathcal{X}(p)}\backslash\textbf{Vars}(h)$
            \item[US2)] $\boxminus(p,\langle hf_0^i\rangle):=\boxminus(p,h)\uplus \boxminus(p,f_0)$
            \item[US3)] $\boxplus(\langle hf_0^i\rangle,p):= i * \boxplus(f_0,p)$

                $\boxplus(\langle hf_0^i\rangle,p_0):= (k-i) * \boxminus(p_0,f_0)$

            \item[US4)] $G(\langle hf_0^i\rangle):= G(h) \land G(f_0)$
            \item[US5)] $I(\langle hf_0^i\rangle):= I(f_0)$
            %\item[US6)] Given that $\boxplus(h,p_0) = \{\langle x_1, x_2, \dots, x_n \rangle\}$ and $\boxminus(p_0, f_0) = \{\langle y_1, y_2, \dots, y_n \rangle\}$, $G(\langle hf \rangle) \land \bigwedge_{i\in[1,n]} (x_i = y_i)$
            \item[US6)] Given that $\boxplus(h,p_0) = \{\langle x_1, x_2, \dots, x_n \rangle\}$ and $\boxminus(p_0, f_0) = \{\langle y_1, y_2, \dots, y_n \rangle\}$\newline
            For $j\in[1,n]$\newline
            Let $l$ be the smallest number s.t.\ $x_l = x_i$ holds:\newline
            $rename(\langle hf_0^i \rangle, x_j, y_l), rename(\langle hf_0^i \rangle, y_j, y_l)$
            %\item[US-optional)] For every expression of the form $x = y$ in $G(\langle hf \rangle)$, replace all instances of variable $x$ in the arcs and guards of $\langle hf \rangle$ with variable $y$
        \end{itemize}
        and
        \begin{itemize}[leftmargin=10mm]
            \item[US7)] Remove $f_0$
            \item[US8)] If $p_0^\bullet = \emptyset$, remove $p_0$ and all transitions in ${}^\bullet p_0\setminus transitions(\varphi)$
        \end{itemize} \\ \hline
        \end{tabular}
    \end{adjustbox}
    \caption{Rule S: Atomic free agglomeration with k-scaled}
    \label{fig:rule_s_cpn}
\end{figure}
